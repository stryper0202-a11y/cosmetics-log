<!-- version: 전체 통합 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>화장품 기록장</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --gap: 10px; --radius: 12px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",Arial,sans-serif; background:#fafafa; color:#111; }
    header { position:sticky; top:0; z-index:10; background:rgba(255,255,255,0.95); border-bottom:1px solid #eee; backdrop-filter:blur(6px); }
    header .wrap { max-width:1100px; margin:0 auto; padding:14px; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    header h1 { font-size:18px; margin:0; }
    header nav { display:flex; gap:8px; flex-wrap:wrap; }
    header nav button { border:1px solid #ddd; background:#fff; padding:7px 11px; border-radius:10px; cursor:pointer; font-size:13px; }
    header nav button.active { background:#111; color:#fff; border-color:#111; }
    main.container { max-width:1100px; margin:18px auto; padding:0 14px 48px; display:grid; gap:16px; }
    .grid { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:1000px) { .grid { grid-template-columns:2fr 1fr; } }
    .card { background:#fff; border:1px solid #eee; border-radius:var(--radius); padding:16px; }
    .card h2 { margin:0 0 10px 0; font-size:18px; }
    .row { display:grid; grid-template-columns:repeat(12,1fr); gap:10px; margin-bottom:10px; }
    .row > label { grid-column: span 3; display:flex; flex-direction:column; gap:6px; font-size:12px; }
    .row > label input, .row > label select, .row > label textarea { padding:9px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; width:100%; }
    .row > label textarea { min-height:70px; resize:vertical; }
    .row.actions { display:flex; gap:8px; margin-bottom:0; flex-wrap:wrap; }
    .btn { border:1px solid #ddd; background:#111; color:#fff; padding:9px 13px; border-radius:10px; cursor:pointer; font-size:13px; }
    .btn.secondary { background:#fff; color:#111; }
    .btn.warn { background:#b42318; color:#fff; border-color:#b42318; }
    .pill { font-size:12px; background:#f1f1f1; border-radius:999px; padding:4px 8px; display:inline-flex; align-items:center; gap:6px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; font-size:14px; }
    tr:hover { background:#fafafa; }
    .muted { color:#666; font-size:12px; }
    .badge { padding:3px 7px; border-radius:999px; background:#eef; font-size:12px; }
    .danger { color:#b42318; }
    .flex { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .right { margin-left:auto; }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; }
    footer { text-align:center; color:#777; font-size:12px; padding:24px; }
    .hint { font-size:12px; color:#666; }
    .filter { display:flex; gap:8px; flex-wrap:wrap; }
    .filter input, .filter select { border:1px solid #ddd; border-radius:10px; padding:8px 10px; font-size:13px; }
    .stat { display:flex; flex-direction:column; gap:4px; padding:10px 12px; border:1px dashed #ddd; border-radius:12px; min-width:150px; background:#fcfcff; }
    .stats { display:flex; flex-wrap:wrap; gap:10px; }
    .nowrap { white-space:nowrap; }
    .small-muted { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>화장품 기록장</h1>
      <nav>
        <button id="tabDashboardBtn" class="active">대시보드</button>
        <button id="tabProductsBtn">제품관리</button>
        <button id="tabUsageBtn">사용기록</button>
        <button id="tabDataBtn">데이터</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- 대시보드 -->
    <section id="tabDashboard" class="card">
      <h2>대시보드</h2>
      <div class="stats" id="dashboardStats"></div>
      <div class="card" style="margin-top:12px;">
        <div class="flex">
          <strong>만료 임박(30일 이내) · 만료된 제품</strong>
          <span class="right muted">PAO 기준</span>
        </div>
        <table id="expiryTable">
          <thead><tr><th>제품</th><th>개봉일</th><th>PAO</th><th>권장 폐기일</th><th>상태</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 제품관리 -->
    <section id="tabProducts" class="grid" style="display:none;">
      <div class="card">
        <h2>제품 추가/수정</h2>
        <form id="productForm">
          <input type="hidden" name="product_id" />
          <div class="row">
            <label style="grid-column: span 3;">브랜드<input name="brand" placeholder="예: COSRX" /></label>
            <label style="grid-column: span 5;">제품명*<input name="product_name" required placeholder="예: Low pH Good Morning Gel Cleanser" /></label>
            <label style="grid-column: span 4;">카테고리<input name="category" placeholder="예: Cleanser" /></label>
          </div>
          <div class="row">
            <label style="grid-column: span 4;">색상/버전<input name="shade_or_variant" placeholder="예: 06 Deep Soul" /></label>
            <label style="grid-column: span 3;">용량(표기)<input name="size" placeholder="예: 150ml / 5.5g" /></label>
            <label style="grid-column: span 2;">용량(숫자)<input name="size_value" type="number" step="0.01" min="0" placeholder="예: 150" /></label>
            <label style="grid-column: span 1;">단위<select name="size_unit"><option value="ml">ml</option><option value="g">g</option></select></label>
            <label style="grid-column: span 2;">가격(원)<input name="price_krw" type="number" min="0" step="1" /></label>
          </div>
          <div class="row">
            <div style="grid-column: span 12;">
              <div id="realtimePricePerUnit" class="small-muted">가격과 용량을 입력하면 원/단위가 자동 계산됩니다.</div>
            </div>
          </div>
          <div class="row">
            <label style="grid-column: span 4;">구매일<input name="purchase_date" type="date" /></label>
            <label style="grid-column: span 4;">개봉일<input name="opened_date" type="date" /></label>
            <label style="grid-column: span 4;">사용완료일<input name="finished_date" type="date" /></label>
          </div>
          <div class="row">
            <label style="grid-column: span 4;">PAO(개월)<input name="period_after_open_months" type="number" min="0" step="1" placeholder="예: 12" /></label>
            <label style="grid-column: span 4;">평점(1~5)<input name="rating_1to5" type="number" min="0" max="5" step="1" /></label>
            <label style="grid-column: span 12;">코멘트<textarea name="comment" placeholder="간단한 메모"></textarea></label>
          </div>
          <div class="row actions">
            <button class="btn" type="submit">저장</button>
            <button class="btn secondary" type="button" id="resetProductForm">새로 입력</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="flex">
          <h2 style="margin:0;">제품 목록</h2>
          <div class="right filter">
            <input id="productSearch" placeholder="제품/브랜드 검색" />
            <select id="categoryFilter"><option value="">전체 카테고리</option></select>
            <select id="productSort" title="정렬">
              <option value="default">정렬: 기본(등록순)</option>
              <option value="ppu-asc">원/단위 오름차순</option>
              <option value="ppu-desc">원/단위 내림차순</option>
            </select>
          </div>
        </div>
        <table id="productsTable">
          <thead>
            <tr>
              <th>브랜드</th><th>제품</th><th>카테고리</th><th class="nowrap">개봉일</th><th class="nowrap">완료일</th><th class="nowrap">원/단위</th><th>통계</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 사용기록 -->
    <section id="tabUsage" class="grid" style="display:none;">
      <div class="card">
        <h2>사용 기록 입력</h2>
        <form id="usageForm">
          <div class="row">
            <label style="grid-column: span 4;">날짜*<input name="date" type="date" required /></label>
            <label style="grid-column: span 8;">제품*<select name="product_id" required></select></label>
          </div>
          <div class="row">
            <label style="grid-column: span 6;">사용량 메모<input name="dose_note" placeholder="예: 2 pumps / pea-sized" /></label>
            <label style="grid-column: span 6;">느낌 메모<input name="feel_note" placeholder="예: 순함, 보송, 발색 굿" /></label>
          </div>
          <div class="row actions">
            <button class="btn" type="submit">추가</button>
            <button class="btn secondary" type="button" id="quickToday">오늘 반복사용</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="flex">
          <h2 style="margin:0;">사용 기록</h2>
          <div class="right filter">
            <input id="usageSearch" placeholder="메모 검색" />
            <select id="usageProductFilter"><option value="">전체 제품</option></select>
          </div>
        </div>
        <table id="usageTable">
          <thead>
            <tr><th>날짜</th><th>제품</th><th>사용량 메모</th><th>느낌</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 데이터 -->
    <section id="tabData" class="grid" style="display:none;">
      <div class="card">
        <h2>내보내기 / 가져오기</h2>
        <div class="flex">
          <button class="btn" id="exportJSON">JSON 내보내기</button>
          <button class="btn" id="exportCSV">CSV 내보내기(제품/사용기록)</button>
          <label class="pill">JSON 가져오기<input type="file" id="importFile" accept=".json" /></label>
          <button class="btn warn" id="clearAll">전체 삭제</button>
          <span class="right muted">모든 데이터는 브라우저(LocalStorage)에만 저장됩니다.</span>
        </div>
        <p class="hint">JSON으로 전체 백업/복원이 가능합니다. 다른 기기로 옮길 때도 JSON 파일만 옮기면 됩니다.</p>
      </div>

      <div class="card">
        <h2>설명</h2>
        <ul class="hint">
          <li>PAO(개월): 개봉 후 사용 권장기간(예: 12M). 개봉일 + PAO로 만료일 계산.</li>
          <li>통계: 사용기간(일), 평균 사용빈도(회/일), 사용당 비용(원/회) 자동 계산.</li>
          <li>오프라인 파일로 열어도 동작합니다.</li>
          <li>원/단위 계산: 가격과 숫자 용량, 단위를 입력하면 자동 계산됩니다.</li>
          <li>제품 목록에서 '원/단위' 기준으로 오름/내림 정렬 가능.</li>
        </ul>
      </div>
    </section>
  </main>

  <footer>© 화장품 기록장 · Local only · JSON 백업 지원</footer>

  <script>
    // === 유틸 ===
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const fmtDate=(d)=>(d?new Date(d).toISOString().slice(0,10):"");
    const daysBetween=(a,b)=>{if(!a||!b)return null;const A=new Date(a),B=new Date(b);return Math.round((B-A)/(1000*60*60*24));};
    const addMonths=(dateStr,months)=>{if(!dateStr||!months)return"";const d=new Date(dateStr);d.setMonth(d.getMonth()+Number(months));return fmtDate(d);};

    // === 저장소 ===
    const LS_KEYS={products:"coslog_products",usage:"coslog_usage"};
    const store={
      getProducts(){return JSON.parse(localStorage.getItem(LS_KEYS.products)||"[]");},
      setProducts(list){localStorage.setItem(LS_KEYS.products,JSON.stringify(list));},
      getUsage(){return JSON.parse(localStorage.getItem(LS_KEYS.usage)||"[]");},
      setUsage(list){localStorage.setItem(LS_KEYS.usage,JSON.stringify(list));},
      clearAll(){localStorage.removeItem(LS_KEYS.products);localStorage.removeItem(LS_KEYS.usage);}
    };

    // === 상태 ===
    let products=store.getProducts();
    let usage=store.getUsage();

    // === ID 생성 ===
    const nextId=(arr,key)=>(arr.reduce((m,o)=>Math.max(m,o[key]||0),0)||0)+1;

    // === 제품 통계 ===
    function productStats(p){
      const logs=usage.filter(u=>u.product_id===p.product_id);
      const timesUsed=logs.length;
      const opened=p.opened_date||null;
      const finished=p.finished_date||null;
      const endDate=finished||fmtDate(new Date());
      const totalDaysOpen=opened?daysBetween(opened,endDate):null;
      const avgPerDay=opened&&totalDaysOpen&&totalDaysOpen>0&&timesUsed>0?timesUsed/totalDaysOpen:null;
      const costPerUse=timesUsed>0&&p.price_krw?Number(p.price_krw)/timesUsed:null;
      const discardDate=p.opened_date&&p.period_after_open_months?addMonths(p.opened_date,p.period_after_open_months):"";
      const todayStr=fmtDate(new Date());
      const pastPAO=discardDate&&new Date(discardDate)<new Date(todayStr);
      return {timesUsed,totalDaysOpen,avgPerDay,costPerUse,discardDate,pastPAO};
    }

    function calcPricePerUnit(price,sizeValue){
      const p=Number(price),v=Number(sizeValue);
      if(!isFinite(p)||!isFinite(v)||v<=0)return null;
      return Math.round((p/v)*100)/100;
    }
    function fmtPricePerUnit(ppu){if(ppu==null)return"-";return ppu.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2});}

    function renderCategoryFilter(){
      const catSet=new Set(products.map(p=>p.category).filter(Boolean));
      $("#categoryFilter").innerHTML='<option value="">전체 카테고리</option>'+[...catSet].map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function renderProductsTable(){
      const tbody=$("#productsTable tbody");
      const search=$("#productSearch").value.toLowerCase();
      const cat=$("#categoryFilter").value;
      const sort=$("#productSort").value;
      let filtered=products.filter(p=>(p.product_name.toLowerCase().includes(search)||p.brand.toLowerCase().includes(search)) && (!cat||p.category===cat));
      if(sort==="ppu-asc") filtered.sort((a,b)=> (a.price_per_unit||Infinity)-(b.price_per_unit||Infinity));
      if(sort==="ppu-desc") filtered.sort((a,b)=> (b.price_per_unit||0)-(a.price_per_unit||0));
      tbody.innerHTML=filtered.map(p=>{
        const s=productStats(p);
        return `<tr>
          <td>${p.brand||""}</td>
          <td>${p.product_name||""}</td>
          <td>${p.category||""}</td>
          <td class="nowrap">${fmtDate(p.opened_date)}</td>
          <td class="nowrap">${fmtDate(p.finished_date)}</td>
          <td class="nowrap">${fmtPricePerUnit(p.price_per_unit)}</td>
          <td class="nowrap">${s.timesUsed}회/${s.totalDaysOpen??"-"}일</td>
          <td class="flex">
            <button class="btn secondary" data-id="${p.product_id}" onclick="editProduct(${p.product_id})">편집</button>
            <button class="btn warn" data-id="${p.product_id}" onclick="deleteProduct(${p.product_id})">삭제</button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderDashboard(){
      const stats=$("#dashboardStats");
      const totalProducts=products.length;
      const totalUsed=usage.length;
      const totalPrice=products.reduce((a,p)=>a+(Number(p.price_krw)||0),0);
      const expired=products.filter(p=>{const d=p.opened_date&&p.period_after_open_months?addMonths(p.opened_date,p.period_after_open_months):null;return d&&new Date(d)<=new Date();});
      stats.innerHTML=`<div class="stat">전체 제품: ${totalProducts}</div>
        <div class="stat">사용 기록: ${totalUsed}</div>
        <div class="stat">총 구매 금액: ${totalPrice.toLocaleString()}원</div>
        <div class="stat danger">만료/PAO 지난 제품: ${expired.length}</div>`;

      const tbody=$("#expiryTable tbody");
      tbody.innerHTML=products.map(p=>{
        const s=productStats(p);
        return `<tr>
          <td>${p.product_name}</td>
          <td>${fmtDate(p.opened_date)}</td>
          <td>${p.period_after_open_months??"-"}개월</td>
          <td>${s.discardDate||"-"}</td>
          <td class="${s.pastPAO?"danger":""}">${s.pastPAO?"만료":"진행중"}</td>
        </tr>`;
      }).join('');
    }

    function editProduct(id){
      const p=products.find(p=>p.product_id===id);
      if(!p)return;
      const form=$("#productForm");
      form.product_id.value=p.product_id;
      form.brand.value=p.brand||"";
      form.product_name.value=p.product_name||"";
      form.category.value=p.category||"";
      form.shade_or_variant.value=p.shade_or_variant||"";
      form.size.value=p.size||"";
      form.size_value.value=p.size_value||"";
      form.size_unit.value=p.size_unit||"ml";
      form.price_krw.value=p.price_krw||"";
      form.purchase_date.value=p.purchase_date||"";
      form.opened_date.value=p.opened_date||"";
      form.finished_date.value=p.finished_date||"";
      form.period_after_open_months.value=p.period_after_open_months||"";
      form.comment.value=p.comment||"";
      form.rating_1to5.value=p.rating_1to5||"";
    }

    function deleteProduct(id){
      if(!confirm("정말 삭제하시겠습니까?")) return;
      products=products.filter(p=>p.product_id!==id);
      store.setProducts(products);
      renderProductsTable();
      renderDashboard();
    }

    // === 탭 ===
    function showTab(tab){
      ["tabDashboard","tabProducts","tabUsage","tabData"].forEach(t=>$("#"+t).style.display=(t===tab?"grid":"none"));
      ["tabDashboardBtn","tabProductsBtn","tabUsageBtn","tabDataBtn"].forEach(b=>$("#"+b).classList.toggle("active",b.toLowerCase().includes(tab.toLowerCase())));
    }
    $("#tabDashboardBtn").onclick=()=>showTab("tabDashboard");
    $("#tabProductsBtn").onclick=()=>showTab("tabProducts");
    $("#tabUsageBtn").onclick=()=>showTab("tabUsage");
    $("#tabDataBtn").onclick=()=>showTab("tabData");

    // === 제품 Form ===
    $("#productForm").addEventListener("submit",e=>{
      e.preventDefault();
      const form=e.target;
      const getRaw=(name)=>form[name]?.value??"";
      const getTrim=(name)=>form[name]?.value.trim()??"";
      const priceNum=Number(getRaw("price_krw"));
      const sizeValueNum=Number(getRaw("size_value"));
      const product_id=form.product_id.value?Number(form.product_id.value):nextId(products,"product_id");
      const newProduct={
        product_id,
        brand:getTrim("brand"),
        product_name:getTrim("product_name"),
        category:getTrim("category"),
        shade_or_variant:getTrim("shade_or_variant"),
        size:getTrim("size"),
        size_value:sizeValueNum||null,
        size_unit:getRaw("size_unit"),
        price_krw:isFinite(priceNum)?priceNum:null,
        price_per_unit:priceNum!=null&&sizeValueNum!=null?calcPricePerUnit(priceNum,sizeValueNum):null,
        purchase_date:getRaw("purchase_date")||"",
        opened_date:getRaw("opened_date")||"",
        finished_date:getRaw("finished_date")||"",
        period_after_open_months:getRaw("period_after_open_months")?Number(getRaw("period_after_open_months")):null,
        comment:getTrim("comment"),
        rating_1to5:getRaw("rating_1to5")?Number(getRaw("rating_1to5")):null
      };
      const idx=products.findIndex(p=>p.product_id===product_id);
      if(idx>=0) products[idx]=newProduct;
      else products.push(newProduct);
      store.setProducts(products);
      form.reset();
      renderCategoryFilter();
      renderProductsTable();
      renderDashboard();
    });

    $("#resetProductForm").onclick=()=>$("#productForm").reset();

    $("#productSearch").oninput=renderProductsTable;
    $("#categoryFilter").onchange=renderProductsTable;
    $("#productSort").onchange=renderProductsTable;

    $("#productForm input[name='price_krw'],#productForm input[name='size_value']").oninput=()=>{
      const price=Number($("#productForm input[name='price_krw']").value);
      const sizeVal=Number($("#productForm input[name='size_value']").value);
      const el=$("#realtimePricePerUnit");
      el.textContent=(price&&sizeVal)?`원/단위: ${calcPricePerUnit(price,sizeVal)}`:"가격과 용량을 입력하면 원/단위가 자동 계산됩니다.";
    };

    // === 초기 렌더 ===
    renderCategoryFilter();
    renderProductsTable();
    renderDashboard();

  </script>
</body>
</html>
